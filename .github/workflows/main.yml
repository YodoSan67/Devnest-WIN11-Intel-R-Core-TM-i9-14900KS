name: 'ğŸ–¥ï¸ Deploy Windows Environment ğŸš€'

on:
  workflow_dispatch:
    inputs:
      GIST_URL:
        description: 'URL skrip PowerShell mentah (contoh: dari Gist)'
        required: true
        default: 'https://gist.githubusercontent.com/ditzz-dev/ea7d0ddc8b8e1a46f98bf9117faf99e2/raw/b0804ba3c6625e3c2eaeb6074e633878f68d8baf/setup-windows.ps1'

jobs:
  validate_and_prepare:
    name: 'ğŸ§ Fase 1: Validasi & Persiapan Sistem'
    runs-on: windows-11-arm
    
    steps:
      - name: 'ğŸ Memulai Proses Deployment'
        run: Write-Host "ğŸš€ Proses deployment Lingkungan Windows dimulai..."
        shell: powershell

      - name: 'ğŸ”— Memvalidasi Input Gist URL'
        shell: powershell
        run: |
          if (-not "${{ github.event.inputs.GIST_URL }}") {
            Write-Error "âŒ FATAL: Harap berikan Gist URL untuk menjalankan alur kerja ini."
            exit 1
          }
          Write-Host "âœ… Gist URL terdeteksi."

      - name: 'ğŸ”‘ Memvalidasi Secret NGROK'
        shell: powershell
        run: |
          if (-not "${{ secrets.NGROK_AUTH_TOKEN }}") {
            Write-Error "âŒ FATAL: Secret 'NGROK_AUTH_TOKEN' tidak ditemukan. Harap atur di Pengaturan > Secrets repositori."
            exit 1
          }
          Write-Host "âœ… Secret NGROK_AUTH_TOKEN ditemukan."
          
      - name: 'ğŸ“¥ Mengunduh Skrip Master dari Gist'
        shell: powershell
        run: |
          Write-Host "â˜ï¸  Mengunduh skrip master dari Gist..."
          Invoke-WebRequest -Uri "${{ github.event.inputs.GIST_URL }}" -OutFile "setup.ps1"
          Write-Host "ğŸ’¾ Skrip master berhasil disimpan sebagai 'setup.ps1'."

      - name: 'ğŸ“¦ Mengemas Skrip sebagai Artefak'
        uses: actions/upload-artifact@v4
        with:
          name: setup-script-artifact
          path: setup.ps1

  execute_deployment:
    name: 'âš¡ Fase 2: Eksekusi & Aktivasi'
    needs: validate_and_prepare
    runs-on: windows-11-arm
    timeout-minutes: 360
    
    steps:
      - name: 'ğŸ“¦ Membuka Paket Artefak Skrip'
        uses: actions/download-artifact@v4
        with:
          name: setup-script-artifact

      - name: 'âš™ï¸ Menjalankan Skrip Deployment Windows'
        shell: powershell
        run: |
          Write-Host "â–¶ï¸  Memulai eksekusi skrip 'setup.ps1'..."
          .\setup.ps1 -NgrokAuthToken "${{ secrets.NGROK_AUTH_TOKEN }}"
          
      - name: 'ğŸ‰ Deployment Selesai & Lingkungan Aktif'
        run: Write-Host "âœ… Lingkungan Windows Anda telah berhasil di-deploy dan siap digunakan!"
        shell: powershell
